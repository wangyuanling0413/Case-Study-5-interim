---
title: "Case Study 5 Interim Report"
author: "Yuanling Wang, Irina Cristali"
date: "11/14/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Introduction
This report aims to explore the missing data patterns and mechanisms of a dataset of cardiac catheterization procedures provided by The Duke Databank for Cardiovascular Disease (DDCD), a clinical care database created by Duke Department of Medicine from 1946 to 1967. The patterns of missing data would be closely examined through visualizations and statistical tests; approaches of handling the missing data including imputation and necessary deletion would follow. The potential for missing data to bias analysis results would also be discussed. 

#Data Preprocessing
The dataset for analysis here is $DUKECATHR$, the version of $DUKECATH$ dataset for educational use. The dataset contains a subset of cardiac catheterization procedures conducted in adult patients at Duke University Medical Center between 1985 and 2013. We first subset the dataset to exclusively include patients whose recorded catheterization in this dataset is their first time of catheterization procedure. The observed variables for each patient include catheterization identification and linking, demographics information, patient history, laboratory results prior to the catheterization, catheterization procedure, catheterization results and the follow-up information. 
 
```{r}
cath = read.csv("dukecathr.csv")
cath1a=subset(cath,cath$RSEQCATHNUM==1)
```
 
#Visualizations of missing data
We now proceed to examine the missing data pattern through data visualizations. To begin with, we group the variables by group considering the way they were collected; within each group, we look at the proportions and distributions of the missing data as well as the missing data pattern for different variables combined. The first three columns of the data on the catheterization identification are complete and were thus excluede from the visualization. 

```{r, include=FALSE}
library(mice)
library(VIM)
library(lattice)
```

```{r}
#cath time and demographics
cath1a_agg1 = aggr(cath1a[,4:7],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,4:7]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

#patient history 1
cath1a_agg2 = aggr(cath1a[,8:12],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,8:12]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

#patient history 2
cath1a_agg3 = aggr(cath1a[,13:22],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,13:22]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

#vital signs
cath1a_agg4 = aggr(cath1a[,23:29],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,23:29]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

#lab results prior to cath
cath1a_agg5 = aggr(cath1a[,30:33],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,30:33]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

#cath procedure
cath1a_agg6 = aggr(cath1a[,34:36],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,34:36]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

#cath results
cath1a_agg7 = aggr(cath1a[,37:45],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,37:45]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))

#follow-up
cath1a_agg8 = aggr(cath1a[,46:52],col=mdc(1:2),numbers=TRUE,sortVars=TRUE,
labels=names(cath1a[,46:52]),cex.axis=.7, gap=3, 
ylab=c("Proportion missing","Missingness Pattern"))
```


--(select several pairs of the variables and do margin plot below:)

```{r}
marginplot(cath1a[, c("RCAST", "DAYS2LKA")], col = mdc(1:2), cex.numbers = 1.2, pch = 19)
```


#Handling missing data

Due to..., we decided to delete the columns where more than a certain proportion of data is missing; the threshold was set to be 10%, mainly because... (literature review). 
```{r}
num_NA = rep(0,ncol(cath1a))

for (i in 1:length(num_NA)){
  num_NA[i] = sum(is.na(cath1a[,i]))
}

prop_NA = num_NA/nrow(cath1a)
propNA_under10perc = prop_NA <= 0.1
index_propNAover = which(propNA_under10perc==FALSE)

cath1a_2 = cath1a[,-index_propNAover]
#research on people's common threshold
```

For the remaining dataset, we performed Multiple Imputation using Chained Equations. 
```{r}
imp <- mice(cath1a_2, m=20, printFlag=FALSE, maxit = 40, seed=2525) 

```